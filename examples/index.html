<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="/codemirror.css">
    <script src="/lodash.min.js"></script>
    <script src="/codemirror.js"></script>
    <script src="/channel/bcsocket.js"></script>
    <script src="/share.uncompressed.js"></script>
    <script src="/share-codemirror.js"></script>
    <script src="/share-codemirror-cursor.js"></script>
    <script src="/tinycolor-min.js"></script>

    <style>

        .user-name {
            color: white;
            font-size: 10px;
            line-height: 1;
            padding: 1px 3px;

            -webkit-border-radius: 3px;
            -moz-border-radius: 3px;
            border-radius: 3px;
        }

        .user-cursor {
            background: black;
        }

        #users input {
            width: 250px;
        }
    </style>
</head>
<body>
<textarea id="pad">Connecting...</textarea>

<div id="myself">
    <input value="">
</div>
<div id="users"></div>
<script>
    var elem = document.getElementById('pad');
    var cm = CodeMirror.fromTextArea(elem, {
        mode: "text/plain"
    });

    var bcs = new BCSocket(null, {reconnect: true});
    var sjs = new window.sharejs.Connection(bcs);
    sjs.debug = false;

    var doc = sjs.get('users', 'sephx');

    doc.subscribe();
    doc.whenReady(function () {
        if (!doc.type) doc.create('text');
        if (doc.type && doc.type.name === 'text') {
            var ctx = doc.createContext();
            doc.attachCodeMirror(cm, ctx);
            doc.attachCodeMirrorCursor(cm, ctx, {inactiveTimeout: 2000});

            // set the color for our session
            var sessionIds = Object.keys(ctx.getPresence());
            // colorbrewer
            var colors = [
                "#8dd3c7", "#bebada", "#fb8072", "#80b1d3", "#fdb462", "#b3de69", "#fccde5", "#d9d9d9", "#bc80bd", "#ccebc5"
            ];
            var color = colors[sessionIds.length % colors.length];
            doc.setPresenceProperty("color", color);

            var selectionColor = tinycolor.lighten(color).toHexString();
            doc.setPresenceProperty("selectionColor", selectionColor);

            var textColor = tinycolor.mostReadable(color, ['black', 'white']).toHexString();
            doc.setPresenceProperty("textColor", textColor);

            var myself = document.getElementById('myself');
            myself.style.background = color;
            var input = myself.getElementsByTagName("input")[0];
            input.value = doc.connection.id;
            input.onkeyup = function () {
                doc.setPresenceProperty("name", input.value);
            };
        }
    });


</script>
</body>
</html>
